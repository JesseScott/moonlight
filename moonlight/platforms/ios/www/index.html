<!DOCTYPE html>
<html>
  <head>

      <!-- META -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">

      <!-- SRC -->
      <script src="cordova.js"></script>
      <script src="js/suncalc/suncalc.js"></script>

      <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="css/index.css" />

  </head>

  <body>

    <!-- DIVS -->
    <div class="app">
      <H1>
        <div id="msg" class="blink"></div>
      </H1>
    </div>

    <!-- CANVAS -->
    <canvas id="canvas" width="100" height="100"></canvas>


    <!-- JAVASCRIPT -->
    <script type="text/javascript">

      // GLOBALS
      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');
      var msg = document.getElementById('msg');

      // INIT
      function init() {
        console.log("-- init --");

        // Resize Canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        //getMoonTime(49.246292, -123.116226); // CHEAT
      }

      // PHONEGAP

      document.addEventListener("deviceready", onDeviceReady, false);

      function onDeviceReady() {
        console.log("-- onDeviceReady --");

        // INIT
        init();

        // Get Current GPS
        var options = { maximumAge: 3000, timeout: 5000, enableHighAccuracy: true };
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(onSuccess, onError);
        }
        else {
          console.log("Can't find GPS system...");
          msg.innerHTML = "ERROR: \ncouldn't find geolocation ability on this device - check permissions and wifi";
        }
      }

      function onSuccess(position) {
        console.log("-- onSuccess --");

        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        console.log("lat is " + lat + " and lon is " + lon);

        getMoonTime(lat, lon);

      }

      function onError(error) {
        console.log("-- onError --");
        console.log('error: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
        msg.innerHTML = "ERROR: \ncouldn't get current location - check permissions and wifi";
      }

      // SUNCALC

      function getMoonTime(lat, lon) {
        console.log("-- getMoonTime --");
        var times = SunCalc.getMoonTimes(Date.now(), lat, lon);
        console.log(times);

        var now = new Date();
        console.log("Now is " + now + '\n');
        var rise = times.rise;
        console.log("Rise is " + rise + '\n');
        var set = times.set;
        console.log("Set is " + set + '\n');

        //if( (now > rise)  && (now < set) ) {
        if(now > rise) {
          console.log("true - the moon rose at " + rise + " and will set at " + set);
          getMoonIllumination();
        }
        else {
          console.log("false - the moon is not within view");

          var remaining =  rise.getHours() - now.getHours();
          //msg.innerHTML = "SORRY:" + '\n' + "The Moon Is Not In View Yet... It Will Rise In " + remaining + " Hours...";

          //getMoonIllumination(); // CHEAT
          setCanvas(0.5);
          msg.innerHTML = "0.5"
        }
      }

      function getMoonIllumination() {
        console.log("-- getMoonIllumination --");
        var lumens = SunCalc.getMoonIllumination(Date.now());
        console.log(lumens);

        var fraction = lumens.fraction;
        setCanvas(fraction);
      }

      // CANVAS

      function setCanvas(fraction) {
        console.log("-- setCanvas --");

        //fraction = fraction.toFixed(3);
        console.log("Fraction is " + fraction);

        context.rect(0, 0, canvas.width, canvas.height);
        var grad = context.createLinearGradient(0, 0, canvas.width, canvas.height);

        /*
        grad.addColorStop(0.0, 'rgba(0, 0, 0, ' + fraction + ')');
        grad.addColorStop(0.5, 'rgba(255, 255, 255, ' + fraction + ')');
        grad.addColorStop(1.0, 'rgba(0, 0, 0, ' + fraction + ')');
        */

        grad.addColorStop(0.000, 'rgba(0, 0, 0, 1.000)'); // BLACK
        grad.addColorStop(0.050, 'rgba(127, 127, 127, 0.500)'); // GREY

        grad.addColorStop(0.400, 'rgba(255, 255, 255, ' + fraction + ')'); // MOON
        grad.addColorStop(0.600, 'rgba(255, 255, 255, ' + fraction + ')'); // MOON

        grad.addColorStop(0.950, 'rgba(127, 127, 127, 0.500)'); // GREY
        grad.addColorStop(1.000, 'rgba(0, 0, 0, 1.000)'); // BLACK


        context.fillStyle = grad;
        context.fill();

        //msg.innerHTML = "moonlight";

      }

    </script>

  </body>

</html>
