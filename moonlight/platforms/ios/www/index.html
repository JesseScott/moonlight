<!DOCTYPE html>
<html>
  <head>

      <!-- META -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
      <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="mobile-web-app-capable" content="yes">

      <!-- SRC -->
      <script src="cordova.js"></script>
      <script src="js/suncalc/suncalc.js"></script>
      <script src="js/hamburger.js"></script>
      <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script src="http://code.jquery.com/mobile/latest/jquery.mobile.min.js"></script>

      <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="css/index.css" />

  </head>

  <body>

    <!-- Container -->
    <div id="container">


        <!-- MOONLIGHT -->
        <div id="light">
            <div class="app">
                <H1>
                  <div id="brand" class="blink"></div>
                </H1>
                <H2>
                  <div id="msg" class="blink"></div>
                </H2>
            </div>
            <canvas id="canvas" width="100" height="100"></canvas>
        </div>

        <!-- DATA -->
        <div id="data">
          <div class="app">
            <H1>
              <div>DATA</div>
            </H1>
          </div>
        </div>

        <!-- ABOUT -->
        <div id="about">
          <div class="app">
              <H1>
                <div>ABOUT</div>
              </H1>
          </div>
        </div>

    </div>

    <!-- JAVASCRIPT -->
    <script type="text/javascript">

      // GLOBALS

      var light = document.getElementById('light');
      var data = document.getElementById('data');
      var about = document.getElementById('about');

      var canvas = document.getElementById('canvas');
      var context = canvas.getContext('2d');

      var msg = document.getElementById('msg');
      var brand = document.getElementById('brand');
      msg.style.display = 'block';
      brand.style.display = 'none';

      var rise, set;
      var lat, lon;
      var lumens;
      var index = 0;

      // INIT
      function init() {
        console.log("-- init --");

        // Resize Canvas
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Hide Screens
        light.style.display = 'block';
        data.style.display = 'none';
        about.style.display = 'none';

        // CHEAT
        //setCanvas(0.80);
        //getMoonTime(49.246292, -123.116226);
      }

      // PHONEGAP

      function onDeviceReady() {
          console.log("-- onDeviceReady --");

          // Status Bar Margin
          if (parseFloat(window.device.version) >= 7.0) {
              //document.body.style.marginTop = "40px";
          }

          // INIT
          init();

          // Get Current GPS
          var options = {
            maximumAge: 3000,
            timeout: 5000,
            enableHighAccuracy: true
          };
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onSuccess, onError);
          }
          else {
            console.log("Can't find GPS system...");
            msg.innerHTML = "ERROR: \ncouldn't find geolocation ability on this device - check permissions and wifi";
          }
      }

      document.addEventListener("deviceready", onDeviceReady, false);

      function onSuccess(position) {
          console.log("-- onSuccess --");

          lat = position.coords.latitude;
          lon = position.coords.longitude;
          console.log("lat is " + lat + " and lon is " + lon);

          getMoonTime(lat, lon);
      }

      function onError(error) {
        console.log("-- onError --");
        console.log('error: '    + error.code    + '\n' + 'message: ' + error.message + '\n');
        msg.innerHTML = "ERROR: \ncouldn't get current location - check permissions and wifi";
      }

      // SUNCALC

      function getMoonTime(lat, lon) {
        console.log("-- getMoonTime --");
        var times = SunCalc.getMoonTimes(Date.now(), lat, lon);
        console.log(times);

        var now = new Date();
        console.log("Now is " + now + '\n');
        rise = times.rise;
        console.log("Rise is " + rise + '\n');
        set = times.set;
        console.log("Set is " + set + '\n');

        //if( (now > rise)  && (now < set) ) {
        if(now > rise) {
          console.log("true - the moon rose at " + rise + " and will set at " + set);
          getMoonIllumination();
        }
        else {
          console.log("false - the moon is not within view");
          var remaining =  rise.getHours() - now.getHours();
          msg.innerHTML = "SORRY:" + '\n' + "The Moon Is Not In View Yet..." + '\n' + "It Will Rise In " + remaining + " Hours...";
        }
      }

      function getMoonIllumination() {
        console.log("-- getMoonIllumination --");
        var illumination = SunCalc.getMoonIllumination(Date.now());
        console.log(illumination);

        lumens = illumination.fraction;
        setCanvas(lumens);
      }

      // CANVAS

      function setCanvas(fraction) {
        console.log("-- setCanvas --");

        //fraction = fraction.toFixed(3);
        console.log("Fraction is " + fraction);

        context.rect(0, 0, canvas.width, canvas.height);
        var grad = context.createLinearGradient(0, 0, canvas.width, canvas.height);

        grad.addColorStop(0.000, 'rgba(0, 0, 0, ' + fraction + ')');
        grad.addColorStop(0.050, 'rgba(25, 25, 25, ' + fraction + ')');
        grad.addColorStop(0.100, 'rgba(50, 50, 50, ' + fraction + ')');
        grad.addColorStop(0.150, 'rgba(75, 75, 75, ' + fraction + ')');
        grad.addColorStop(0.200, 'rgba(100, 100, 100, ' + fraction + ')');
        grad.addColorStop(0.250, 'rgba(125, 125, 125, ' + fraction + ')');
        grad.addColorStop(0.300, 'rgba(150, 150, 150, ' + fraction + ')');
        grad.addColorStop(0.350, 'rgba(175, 175, 175, ' + fraction + ')');
        grad.addColorStop(0.400, 'rgba(200, 200, 200, ' + fraction + ')');
        grad.addColorStop(0.450, 'rgba(225, 225, 225, ' + fraction + ')');
        grad.addColorStop(0.500, 'rgba(250, 250, 250, ' + fraction + ')');
        grad.addColorStop(0.550, 'rgba(225, 225, 225, ' + fraction + ')');
        grad.addColorStop(0.600, 'rgba(200, 200, 200, ' + fraction + ')');
        grad.addColorStop(0.650, 'rgba(175, 175, 175, ' + fraction + ')');
        grad.addColorStop(0.700, 'rgba(150, 150, 150, ' + fraction + ')');
        grad.addColorStop(0.750, 'rgba(125, 125, 125, ' + fraction + ')');
        grad.addColorStop(0.800, 'rgba(100, 100, 100, ' + fraction + ')');
        grad.addColorStop(0.850, 'rgba(75, 75, 75, ' + fraction + ')');
        grad.addColorStop(0.900, 'rgba(50, 50, 50, ' + fraction + ')');
        grad.addColorStop(0.950, 'rgba(25, 25, 25, ' + fraction + ')');
        grad.addColorStop(1.000, 'rgba(0, 0, 0, ' + fraction + ')');

        context.shadowBlur = 500;
        context.shadowColor = "white";

        context.fillStyle = grad;
        context.fill();

        msg.style.display = 'none';
        brand.style.display = 'block';
        brand.innerHTML = "MOONLIGHT";
      }

      // JQUERY

      // Tap
      $("body").bind('tap', function(event) {
        console.log("-- JQM TAP --");
        event.stopImmediatePropagation();
        switchView();
      });

      function switchView() {
        console.log("-- switchView --");

        index++;
        if(index %3 == 0) {
          light.style.display = 'block';
          data.style.display = 'none';
          about.style.display = 'none';
        }
        else if(index %3 == 1) {
          light.style.display = 'none';
          data.style.display = 'block';
          about.style.display = 'none';
        }
        else if(index %3 == 2) {
          light.style.display = 'none';
          data.style.display = 'none';
          about.style.display = 'block';
        }

      }


    </script>

  </body>

</html>
